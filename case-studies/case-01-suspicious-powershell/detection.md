# Detection

## Detection Source
The activity was detected through endpoint telemetry generated by Sysmon and Windows Event Logs.

## Signal Description
An alert was triggered based on the execution of `powershell.exe` with suspicious command-line parameters indicative of script execution and potential misuse of built-in system tools.

Key indicators include:
- PowerShell execution with encoded or obfuscated commands
- Suspicious command-line flags (e.g., `-EncodedCommand`, `-ExecutionPolicy Bypass`, `-NoProfile`)
- Execution initiated by a non-administrative user


## Detection Logic
The detection focuses on identifying PowerShell executions that deviate from typical user behavior and match known patterns of abuse.

This logic is aligned with MITRE ATT&CK technique:
- **T1059.001 – PowerShell**

## Initial Assessment
Based on the command-line characteristics and user context, the activity is considered suspicious and requires further investigation.

## Detection Implementation – Splunk

The detection logic was implemented in Splunk as a scheduled alert to identify suspicious PowerShell executions involving commonly abused flags.

### Detection Logic

The following SPL query was used:

index=main source="WinEventLog:Microsoft-Windows-Sysmon/Operational"
EventCode=1
Image="*powershell*"
(CommandLine="*-EncodedCommand*" OR CommandLine="*-NoProfile*" OR CommandLine="*-ExecutionPolicy Bypass*")

### Rationale

The selected flags are frequently observed in script-based execution and adversary tradecraft, particularly when attempting to bypass execution policies or run non-interactive PowerShell commands.

This detection is aligned with:

MITRE ATT&CK – T1059.001 (PowerShell)

### Alert Configuration

- Type: Scheduled
- Frequency: Every hour
- Time range: Last 60 minutes
- Trigger condition: Number of results > 0
- Severity: Medium
- Scope: Shared within the application

### Validation

The detection was validated by executing controlled PowerShell commands using the identified flags. The resulting process creation events (Sysmon Event ID 1) were successfully indexed in Splunk and matched by the detection logic.

This confirms that the end-to-end telemetry pipeline and alerting workflow are functioning correctly.

## Limitations & Future Improvements

### Current Limitations

- The detection relies solely on command-line flags and does not incorporate behavioral correlation (e.g., network activity, parent process anomalies).
- Legitimate administrative activity may generate similar PowerShell executions, potentially leading to false positives.
- The alert does not currently differentiate between interactive and automated execution contexts.
- No threat intelligence enrichment or reputation checks are applied.

### Future Improvements

- Correlate PowerShell execution with suspicious parent processes (e.g., Office applications spawning PowerShell).
- Detect long or highly obfuscated encoded commands.
- Incorporate network connection telemetry (Sysmon Event ID 3) to identify potential command-and-control behavior.
- Add user context analysis (privilege level, frequency baseline).
- Translate the detection into Sigma format for portability across SIEM platforms.

